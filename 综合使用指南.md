# 医学报告处理工具集 - 综合使用指南

> **完整版本：整合了所有工具的使用说明、配置方法和最佳实践**

## 📋 目录

1. [概述](#概述)
2. [快速开始](#快速开始)
3. [工具1：结构化提取工具](#工具1结构化提取工具)
4. [工具2：患者友好化工具](#工具2患者友好化工具)
5. [工具3：微调数据集转换工具](#工具3微调数据集转换工具)
6. [API 供应商配置](#api-供应商配置)
7. [模板系统](#模板系统)
8. [常见问题](#常见问题)
9. [快速参考](#快速参考)

---

## 概述

本工具集包含三个主要工具，用于处理医学报告：

### 工具1：结构化提取工具
**功能**：从医学报告中提取结构化字段（如肿瘤位置、大小、转移情况等）

**命令**：`python -m rcc_extract.cli`

**适用场景**：
- 需要将非结构化报告转换为结构化数据
- 批量处理大量报告
- 提取特定疾病的关键信息

### 工具2：患者友好化工具
**功能**：将专业的医学报告转换为患者容易理解的简洁语言

**命令**：`python patient_friendly_cli.py`

**适用场景**：
- 生成患者可读的报告说明
- 医学宣教材料制作
- 患者沟通辅助

### 工具3：微调数据集转换工具
**功能**：将 CSV 数据转换为模型微调所需的 JSONL 格式

**命令**：`python convert_to_finetune.py`

**适用场景**：
- 准备微调数据集
- 创建有监督学习样本
- 模型训练数据准备

---

## 快速开始

### 环境准备

```powershell
# 设置 API Key（以阿里云为例）
$env:ALIYUN_API_KEY = "sk-your-aliyun-key"
```

### 工具1：结构化提取（5分钟上手）

```powershell
python -m rcc_extract.cli `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --limit 5  # 先测试 5 条
```

### 工具2：患者友好化（5分钟上手）

```powershell
python patient_friendly_cli.py `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --limit 5  # 先测试 5 条
```

### 工具3：微调数据集转换（5分钟上手）

```powershell
python convert_to_finetune.py `
  --input "数据.csv" `
  --system "你是一名医学影像分析助手" `
  --user-col "检查所见" `
  --assistant-col "提取结果" `
  --output "finetune.jsonl"
```

---

## 工具1：结构化提取工具

### 核心功能

- ✅ **多 API 供应商**：SiliconFlow、阿里云百炼、OpenAI、DeepSeek、钱多多
- ✅ **模板化提取**：肾癌、肺癌、通用，支持自定义模板
- ✅ **双模式运行**：同步模式（实时进度）+ 批量模式（后台处理）
- ✅ **智能错误处理**：自动 429 重试、配额管理
- ✅ **多列输入支持**：可合并多个 CSV 列

### 基本用法

#### 同步模式（推荐小批量，< 50 条）

```powershell
python -m rcc_extract.cli `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --rpm 20 `
  --concurrency 5
```

#### 批量模式（推荐大批量，50+ 条）

```powershell
python -m rcc_extract.cli `
  --mode batch `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

### 多列输入支持

**单列模式：**
```powershell
python -m rcc_extract.cli `
  --text-col "检查所见" `
  --input "数据.csv"
```

**多列模式（自动合并）：**
```powershell
python -m rcc_extract.cli `
  --text-cols "检查所见,检查结论,诊断建议" `
  --input "数据.csv"
```

多列文本会自动合并为：
```
[检查所见]
右肺上叶见占位...

[检查结论]
考虑肺癌

[诊断建议]
建议增强扫描
```

### 预设模板

#### 1. 肾癌核医学报告（rcc，默认）

```powershell
python -m rcc_extract.cli `
  --template rcc `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

**提取字段：**
- `modality` - 检查方式（PETCT/骨显像/SPECT/CT等）
- `exam_overview` - 检查基础信息
- `renal_status` - 肾脏核心状态
- `radioactive_findings` - 放射性异常核心
- `metastasis_summary` - 肾癌相关转移/累及
- `surgery_history` - 关键手术史
- `notes` - 补充说明

#### 2. 肺癌 CT 报告（lung_cancer）

```powershell
python -m rcc_extract.cli `
  --template lung_cancer `
  --input "肺癌数据.csv" `
  --text-col "检查所见" `
  --id-col "病历号"
```

**提取字段：**
- `exam_type` - 检查类型（平扫/增强等）
- `tumor_location` - 肿瘤位置
- `tumor_size` - 肿瘤大小
- `tumor_characteristics` - 肿瘤特征
- `lymph_node_status` - 淋巴结状态
- `metastasis_status` - 转移状态
- `metastasis_sites` - 转移部位
- `pleural_effusion` - 胸腔积液
- `notes` - 补充说明

#### 3. 通用医学报告（generic）

```powershell
python -m rcc_extract.cli `
  --template generic `
  --input "检查报告.csv" `
  --text-col "报告内容" `
  --id-col "ID"
```

### 运行模式详解

#### 同步模式（sync）

**特点：**
- ✅ 实时显示进度
- ✅ 适合任意数据量
- ✅ 需要手动控制配额
- ✅ 适合小批量数据或测试

**示例：**
```powershell
python -m rcc_extract.cli `
  --mode sync `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --rpm 20 `
  --concurrency 5 `
  --limit 10
```

#### 批量模式（batch）

**特点：**
- ✅ 后台队列处理
- ✅ 自动管理配额
- ✅ 适合大批量数据（50+ 条）
- ✅ 需要轮询状态

**支持的供应商：**
- ✅ SiliconFlow
- ✅ 阿里云百炼
- ✅ OpenAI
- ❓ 钱多多 API（需验证）
- ❌ DeepSeek（自动提示使用同步模式）

**示例：**
```powershell
python -m rcc_extract.cli `
  --mode batch `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --poll-interval 15
```

### 完整参数列表

| 参数 | 说明 | 示例值 | 默认值 |
|------|------|--------|--------|
| `--input` | 输入 CSV 路径 | `工作簿2.csv` | **必需** |
| `--text-col` | 文本列名（单列模式） | `检查所见` | 自动检测 |
| `--text-cols` | 文本列名（多列模式，逗号分隔） | `检查所见,检查结论,诊断建议` | - |
| `--id-col` | ID 列名 | `门诊号/住院号` | 自动检测 |
| `--template` | 提取模板 | `rcc`, `lung_cancer`, `generic` | `rcc` |
| `--provider` | API 供应商 | `siliconflow`, `aliyun`, `openai`, `deepseek`, `qianduoduo` | `siliconflow` |
| `--api-url` | 自定义 API URL | `https://api.example.com/v1` | - |
| `--api-key` | API Key | `sk-xxxxx` | 从环境变量读取 |
| `--model` | 模型 ID | `qwen-plus`, `gpt-4` | - |
| `--mode` | 运行模式 | `sync`, `batch` | `sync` |
| `--rpm` | 每分钟请求数 | `10`, `20`, `60` | `30` |
| `--concurrency` | 并发请求数 | `2`, `5`, `20` | `5` |
| `--timeout` | 单次请求超时（秒） | `60`, `120` | `60` |
| `--max-retries` | 最大重试次数 | `3`, `5` | `3` |
| `--poll-interval` | 批量模式轮询间隔（秒） | `15`, `30` | `15` |
| `--limit` | 仅处理前 N 条 | `10`, `50` | 全部 |
| `--out` | 输出目录前缀 | `outputs_test` | 自动生成 |
| `--temperature` | 响应温度 | `0.0`, `0.7` | `0.0` |
| `--max-chars` | 单条文本最大长度 | `5000`, `10000` | `10000` |
| `--dry-run` | 仅预览不调用 API | - | `false` |

### 并发与配额管理

#### `concurrency` 参数详解

**`concurrency=20` 的含义：同时最多有 20 个独立的 API 请求在执行**

**工作原理：**
```
数据1 ──→ API 请求1 ──┐
数据2 ──→ API 请求2 ──┤
数据3 ──→ API 请求3 ──┤
...                    ├─→ 同时执行（最多 concurrency 个）
数据20 ──→ API 请求20 ─┘
数据21 ──→ 等待...（等前面完成一个后开始）
```

**不是：** ❌ 让 AI 一次输出 20 条  
**而是：** ✅ 同时发起 20 次独立的 API 调用，每条数据一个请求

#### 推荐配置

| API 供应商 | 免费层限制 | 推荐 RPM | 推荐 Concurrency |
|-----------|----------|----------|-----------------|
| **阿里云百炼** | 50-100/分钟 | 40 | 5-10 |
| **SiliconFlow** | 30-60/分钟 | 30 | 5-10 |
| **OpenAI** | 20/分钟 | 15 | 3-5 |
| **Gemini (免费)** | 10/分钟 | 8 | 2 |
| **DeepSeek** | 20-30/分钟 | 15 | 3-5 |
| **钱多多 API** | 视具体模型而定 | 15-20 | 3-5 |

#### 计算公式

**安全并发数 = (RPM 限制 / 2) - 1**

#### 429 错误处理

系统会自动处理 429 错误（配额超限）：
1. ✅ 自动检测 429 错误
2. ✅ 解析 API 建议的延迟时间
3. ✅ 自动等待后重试（使用 API 建议的延迟 + 2 秒缓冲）
4. ✅ 最多重试 3 次（可配置 `--max-retries`）

**示例输出：**
```
⚠️  配额超限，等待 40.4 秒后重试（尝试 1/4）...
⚠️  配额超限，等待 42.8 秒后重试（尝试 2/4）...
✅ 请求成功
```

### 输出格式

**输出目录结构：**
```
outputs/
└── 工作簿2_20251102_140033/
    ├── rcc_extractions.csv      # CSV 格式结果
    └── rcc_extractions.jsonl     # JSON Lines 格式（详细信息）
```

---

## 工具2：患者友好化工具

### 功能说明

将专业的医学影像报告转换为患者容易理解的简洁语言。

**示例转换：**

**原文（专业）：**
```
PET/CT，F-18-FDG。左肾癌术后，左肾窝内未见异常密度影及放射性摄取增高灶；右肾实质未见异常密度影及放射性异常增高灶。右侧肾上腺SUVmax 3.9, 甲状腺SUVmax 3.8, 枕骨偏右侧骨质破坏伴2.0×2.8cm软组织结节SUVmax 4.4。
```

**转换后（患者友好）：**
```
您做了 PET/CT 检查。之前的左肾癌手术区域没有发现异常。右肾看起来正常。检查发现右侧肾上腺、甲状腺和枕骨有一些代谢增高的地方，其中枕骨有一个约2厘米的异常区域。这些发现需要进一步关注。
```

### 基本用法

```powershell
python patient_friendly_cli.py `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

### 使用阿里云 API

```powershell
# 设置 API Key
$env:ALIYUN_API_KEY = "sk-your-key"

# 运行转换
python patient_friendly_cli.py `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --rpm 20 `
  --concurrency 5
```

### 使用钱多多 API

```powershell
$env:QIANDUODUO_API_KEY = "sk-your-key"

python patient_friendly_cli.py `
  --provider qianduoduo `
  --model "gpt-4.1-mini" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

### 多列输入支持

```powershell
python patient_friendly_cli.py `
  --input "完整报告.csv" `
  --text-cols "检查所见,检查结论,诊断建议" `
  --id-col "病历号"
```

### 自定义提示词

#### 方法1：直接指定

```powershell
python patient_friendly_cli.py `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --system-prompt "你是一名医学翻译专家，请用最简单、最温和的语言解释医学报告，避免任何可能引起患者焦虑的词汇..."
```

#### 方法2：从文件读取

```powershell
# 创建提示词文件 prompt.txt
echo "你是一名医学翻译专家..." > prompt.txt

# 使用提示词文件
python patient_friendly_cli.py `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --system-prompt-file "prompt.txt"
```

### 默认提示词

```
你是一名专业的医学翻译助手，任务是将专业的医学影像报告转换为患者容易理解的简洁语言。

要求：
1. 使用通俗易懂的语言，避免专业术语（如必须使用，请简单解释）
2. 保持关键信息的准确性
3. 语言简洁明了，适合普通患者阅读
4. 保持友好的语气
5. 如果报告中有严重异常，请温和但清晰地说明

输出格式：
直接输出简化后的文本，不要添加额外的说明或格式标记。
```

### 完整参数列表

| 参数 | 说明 | 示例 | 必需 |
|------|------|------|------|
| `--input` | 输入 CSV 文件 | `工作簿2.csv` | ✅ |
| `--output` | 输出目录 | `outputs/友好化` | ❌（自动生成）|
| `--text-col` | 文本列名（单列） | `检查所见` | ❌（自动检测）|
| `--text-cols` | 文本列名（多列，逗号分隔） | `检查所见,检查结论` | ❌ |
| `--id-col` | ID 列名 | `门诊号/住院号` | ❌（自动检测）|
| `--provider` | API 供应商 | `aliyun`, `qianduoduo` | ❌ |
| `--api-url` | 自定义 API URL | `https://api.example.com/v1` | ❌ |
| `--api-key` | API Key | `sk-xxxxx` | ❌（从环境变量读取）|
| `--model` | 模型 ID | `qwen-plus`, `gpt-4.1-mini` | ❌ |
| `--temperature` | 响应温度 | `0.3`, `0.7` | ❌（默认：0.3）|
| `--rpm` | 每分钟请求数 | `10`, `20` | ❌（默认：30）|
| `--concurrency` | 并发数 | `2`, `5` | ❌（默认：5）|
| `--system-prompt` | 自定义提示词 | `"你是一名..."` | ❌ |
| `--system-prompt-file` | 从文件读取提示词 | `prompt.txt` | ❌ |
| `--limit` | 仅处理前 N 条 | `10`, `50` | ❌ |
| `--encoding` | CSV 编码 | `utf-8-sig`, `gbk` | ❌（默认：utf-8-sig）|

### Temperature 设置建议

**默认值：0.3**（比提取任务稍高，让语言更自然）

- **0.0-0.2**：更严谨、准确，但可能稍显生硬
- **0.3-0.5**：平衡准确性和可读性（推荐）
- **0.6-0.8**：更自然、流畅，但可能不够严谨
- **0.9+**：非常自然，但可能不够准确

### 输出格式

**CSV 格式：**
```csv
id,original_text,simplified_text,error
1000908157,PET/CT，F-18-FDG...,您做了 PET/CT 检查...,
```

**JSONL 格式：**
```json
{"id": "1000908157", "original_text": "PET/CT，F-18-FDG...", "simplified_text": "您做了 PET/CT 检查...", "error": null}
```

**输出目录：**
```
patient_friendly_outputs/
└── 工作簿2_20251102_140033/
    ├── patient_friendly.csv
    └── patient_friendly.jsonl
```

---

## 工具3：微调数据集转换工具

### 核心概念

脚本将 CSV 的指定列转换为微调数据格式：

```json
{"messages": [
  {"role": "system", "content": "A"},    // 你指定的 system prompt
  {"role": "user", "content": "B"},      // CSV 中的 user 列内容
  {"role": "assistant", "content": "C"}  // CSV 中的 assistant 列内容（可选）
]}
```

### 基本用法

#### 示例1：只有 user（无 assistant）

```powershell
python convert_to_finetune.py `
  --input "数据.csv" `
  --system "你是一名医学影像分析助手" `
  --user-col "检查所见"
```

**CSV 格式：**
```csv
检查所见
右肺上叶见占位...
左肾缺如，右肾正常...
```

**生成的 JSONL：**
```json
{"messages": [{"role": "system", "content": "你是一名医学影像分析助手"}, {"role": "user", "content": "右肺上叶见占位..."}]}
{"messages": [{"role": "system", "content": "你是一名医学影像分析助手"}, {"role": "user", "content": "左肾缺如，右肾正常..."}]}
```

#### 示例2：包含 assistant（有监督微调）

```powershell
python convert_to_finetune.py `
  --input "数据.csv" `
  --system "你是一名医学影像分析助手" `
  --user-col "检查所见" `
  --assistant-col "提取结果"
```

**CSV 格式：**
```csv
检查所见,提取结果
右肺上叶见占位...,{"exam_type": "增强CT", "tumor_location": "右肺上叶"}
左肾缺如...,{"modality": "PETCT", "renal_status": "左肾缺如"}
```

**生成的 JSONL：**
```json
{"messages": [{"role": "system", "content": "你是一名医学影像分析助手"}, {"role": "user", "content": "右肺上叶见占位..."}, {"role": "assistant", "content": "{\"exam_type\": \"增强CT\", \"tumor_location\": \"右肺上叶\"}"}]}
```

#### 示例3：多列 user（自动合并）

```powershell
python convert_to_finetune.py `
  --input "数据.csv" `
  --system "你是一名医学影像分析助手" `
  --user-cols "检查所见,检查结论,诊断建议"
```

#### 示例4：多列 assistant（自动合并）

```powershell
python convert_to_finetune.py `
  --input "数据.csv" `
  --system "你是一名医学影像分析助手" `
  --user-col "检查所见" `
  --assistant-cols "字段1,字段2,字段3"
```

### 完整参数列表

| 参数 | 说明 | 示例 | 必需 |
|------|------|------|------|
| `--input` | 输入 CSV 文件 | `data.csv` | ✅ |
| `--output` | 输出 JSONL 文件 | `finetune.jsonl` | ❌（默认：输入名.jsonl）|
| `--system` | System prompt（A） | `"你是一名..."` | ✅ |
| `--user-col` | User 列名（单列，B） | `检查所见` | ✅（与 --user-cols 二选一）|
| `--user-cols` | User 列名（多列，逗号分隔） | `检查所见,检查结论` | ✅（与 --user-col 二选一）|
| `--assistant-col` | Assistant 列名（单列，C） | `提取结果` | ❌ |
| `--assistant-cols` | Assistant 列名（多列，逗号分隔） | `字段1,字段2` | ❌ |
| `--encoding` | CSV 编码 | `utf-8-sig`, `gbk` | ❌（默认：utf-8-sig）|

### 实际应用示例

#### 场景1：从提取结果 CSV 生成微调数据

**步骤1：使用工具提取数据**
```powershell
python -m rcc_extract.cli `
  --template rcc `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --out "outputs_finetune"
```

**步骤2：转换为微调格式**
```powershell
python convert_to_finetune.py `
  --input "工作簿2.csv" `
  --system "你是一名核医学影像科医生助手，任务是从 PET/CT 或骨显像报告的"检查所见"描述中提取肾癌相关结构化特征。" `
  --user-col "检查所见" `
  --assistant-col "提取结果" `
  --output "rcc_finetune.jsonl"
```

**注意**：需要手动合并两个 CSV（原始数据 + 提取结果），或者修改脚本支持从两个文件读取。

#### 场景2：从 JSONL 输出生成微调数据

如果你之前运行过工具，有 JSONL 输出文件，可以先提取 JSON，然后创建包含 user 和 assistant 列的 CSV。

### 注意事项

1. **列名必须完全匹配** CSV 中的列名
2. **空行会自动跳过** 如果 user 列为空，该行不会写入
3. **多列自动合并** user 或 assistant 多列时会自动合并，每列添加 `[列名]` 标签
4. **Assistant 可选** 如果不指定 assistant 列，生成的数据只包含 system 和 user

---

## API 供应商配置

### 支持的供应商

| 供应商 | 批量推理 | 推荐场景 | 免费层配额 |
|--------|---------|---------|-----------|
| **阿里云百炼** | ✅ 支持 | 国内用户首选 | 50-100/分钟 |
| **SiliconFlow** | ✅ 支持 | 性价比高 | 30-60/分钟 |
| **OpenAI** | ✅ 支持 | 高质量输出 | 20/分钟 |
| **钱多多 API** | ❓ 需验证 | API 聚合服务 | 视具体模型而定 |
| **DeepSeek** | ❌ 不支持 | 同步模式可用 | 20-30/分钟 |

### 1. 阿里云百炼（推荐）

```powershell
# 设置 API Key
$env:ALIYUN_API_KEY = "sk-your-aliyun-key"

# 同步模式
python -m rcc_extract.cli `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --mode sync `
  --rpm 20 `
  --concurrency 5

# 批量模式（推荐）
python -m rcc_extract.cli `
  --mode batch `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

**可用模型：**
- `qwen-plus` (推荐，性价比高)
- `qwen-max` (最强性能)
- `qwen-turbo` (最快速度)

**获取 API Key：**
1. 访问：https://bailian.console.aliyun.com/
2. 开通"百炼"服务
3. 创建 API Key

### 2. SiliconFlow（默认）

```powershell
$env:SILICONFLOW_API_KEY = "sk-your-key"

python -m rcc_extract.cli `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

### 3. 钱多多 API

[钱多多 API](https://ob6nfbpu76.apifox.cn/124951880e0) 是一个 API 聚合服务，提供多个模型的访问，使用 OpenAI 兼容接口。

```powershell
# 设置 API Key
$env:QIANDUODUO_API_KEY = "sk-your-key"

# 同步模式（结构化提取）
python -m rcc_extract.cli `
  --provider qianduoduo `
  --model "gpt-4.1-mini" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --mode sync `
  --rpm 20 `
  --concurrency 5

# 患者友好化
python patient_friendly_cli.py `
  --provider qianduoduo `
  --model "gpt-4.1-mini" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

**API 信息：**
- **Base URL**：`https://api2.aigcbest.top/v1`
- **接口格式**：OpenAI 兼容的 `/chat/completions`
- **认证方式**：Bearer Token（Authorization header）

**可用模型：**
- 支持多种模型，需要在 API 文档中查看可用模型列表
- 默认模型：`gpt-4.1-mini`
- 所有模型均适配 `v1/chat/completions`，只需要把模型名称完整复制到 `model` 参数即可

**注意事项：**
- ✅ 使用 OpenAI 兼容接口，支持同步模式
- ❓ 批量推理支持情况需验证
- 配额和限制请查看 [API 文档](https://ob6nfbpu76.apifox.cn/124951880e0)

### 4. OpenAI

```powershell
$env:OPENAI_API_KEY = "sk-your-key"

python -m rcc_extract.cli `
  --provider openai `
  --model "gpt-4" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

### 5. DeepSeek

```powershell
$env:DEEPSEEK_API_KEY = "sk-your-key"

python -m rcc_extract.cli `
  --provider deepseek `
  --model "deepseek-chat" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --mode sync  # DeepSeek 不支持批量模式
```

### 6. 自定义 API

```powershell
# 方法1：命令行参数
python -m rcc_extract.cli `
  --api-url "https://your-api.com/v1" `
  --api-key "sk-your-key" `
  --model "your-model-id" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"

# 方法2：环境变量
$env:API_BASE_URL = "https://your-api.com/v1"
$env:API_KEY = "sk-your-key"
$env:API_MODEL = "your-model-id"

python -m rcc_extract.cli --input "工作簿2.csv" --text-col "检查所见" --id-col "门诊号/住院号"
```

### 环境变量配置

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `ALIYUN_API_KEY` | 阿里云 API Key | `sk-xxx` |
| `SILICONFLOW_API_KEY` | SiliconFlow API Key | `sk-xxx` |
| `OPENAI_API_KEY` | OpenAI API Key | `sk-xxx` |
| `QIANDUODUO_API_KEY` | 钱多多 API Key | `sk-xxx` |
| `DEEPSEEK_API_KEY` | DeepSeek API Key | `sk-xxx` |
| `API_KEY` | 通用 API Key | `sk-xxx` |
| `API_BASE_URL` | 自定义 API URL | `https://...` |
| `API_MODEL` | 默认模型 | `qwen-plus` |
| `EXTRACTION_TEMPLATE` | 默认模板 | `rcc` |
| `RCC_OUTPUT_DIR` | 输出目录 | `outputs` |
| `RCC_RPM` | 默认 RPM | `30` |
| `RCC_CONCURRENCY` | 默认并发数 | `5` |

---

## 模板系统

### 模板概述

模板定义了从医学报告中提取哪些字段，以及如何提示 AI 提取这些字段。

每个模板包含：
1. **字段定义**（FieldConfig）- 要提取什么信息
2. **提示词**（Prompt）- 如何告诉 AI 提取这些信息

### 创建自定义模板

#### 快速步骤

1. **编辑 `rcc_extract/templates.py`**，在文件末尾添加新模板：

```python
# 示例：肝癌模板
LIVER_CANCER_TEMPLATE = ExtractionTemplate(
	template_id="liver_cancer_ct",
	template_name="肝癌 CT/MRI 报告",
	description="从肝脏影像报告中提取肝癌相关特征",
	fields=[
		FieldConfig(
			name="exam_type",
			display_name="检查类型",
			description="CT/MRI 及扫描方式（平扫/增强等）",
			field_type="enum",
			enum_values=["平扫 CT", "增强 CT", "MRI 平扫", "MRI 增强", "unknown"],
			required=True,
			example="增强 CT"
		),
		FieldConfig(
			name="tumor_location",
			display_name="肿瘤位置",
			description="肝脏哪个段/叶，如'肝右叶 S7 段'",
			example="肝右叶 S7 段"
		),
		# ... 更多字段
	]
)
```

2. **在 `TEMPLATES` 字典中注册**：

```python
TEMPLATES: Dict[str, ExtractionTemplate] = {
	"rcc": RCC_TEMPLATE,
	"lung_cancer": LUNG_CANCER_TEMPLATE,
	"generic": GENERIC_TEMPLATE,
	"liver_cancer": LIVER_CANCER_TEMPLATE,  # ← 添加这一行
}
```

3. **直接使用**：

```powershell
python -m rcc_extract.cli `
  --template liver_cancer `
  --input "肝癌数据.csv" `
  --text-col "报告内容" `
  --id-col "病历号"
```

#### 字段配置详解

```python
FieldConfig(
	name="字段名",              # 必填：字段名（英文，snake_case）
	display_name="显示名称",      # 必填：中文显示名称
	description="字段说明",      # 必填：详细说明，AI 根据这个提取
	field_type="string",         # 可选：字段类型（string/enum/number）
	enum_values=[...],           # 可选：枚举值列表
	required=False,              # 可选：是否必填
	example="示例值"             # 可选：示例值，帮助 AI 理解格式
)
```

#### 提示词编写

**方法1：自动生成（简单场景）**

不提供 `system_prompt_template`，系统会根据字段自动生成。

**方法2：手动编写（推荐，更精确）**

提供 `system_prompt_template`，完全自定义提示词：

```python
LIVER_CANCER_TEMPLATE = ExtractionTemplate(
	template_id="liver_cancer",
	template_name="肝癌报告",
	fields=[...],
	system_prompt_template="""
	你是一名医学影像报告分析助手，任务是从"肝癌 CT/MRI 报告"的检查报告中提取结构化信息。

	- 严格输出 JSON，对象结构如下：
	  {
	    "exam_type": "平扫 CT|增强 CT|MRI 平扫|MRI 增强|unknown",
	    "tumor_location": 字符串或 null,
	    ...
	  }
	- 所有枚举值必须为指定的值。
	- 若原文未提及，填空字符串 "" 或 null；无法判断时枚举字段填 "unknown"。
	- 仅提取文本中明确出现的信息，不要推测。
	"""
)
```

### 模板设计最佳实践

1. **字段命名**：使用 snake_case，清晰明了
2. **字段描述**：详细说明，帮助 AI 理解
3. **枚举值设计**：使用规范的值（如"阴性"、"阳性"，而非"有"、"没有"）
4. **提示词优化**：结构清晰，分点说明，提供示例

### 完整指南

详细的自定义模板创建指南，请查看 [`自定义模板创建指南.md`](./自定义模板创建指南.md)

---

## 常见问题

### 工具相关

**Q: 如何查看我的 API 是否兼容？**
A: 只要 API 遵循 OpenAI Chat Completions 标准（支持 `messages`、`response_format` 等），即可使用本工具。

**Q: 批量模式支持哪些供应商？**
A: 目前支持：
- ✅ **SiliconFlow** - 完整支持
- ✅ **阿里云百炼** - 完整支持（推荐）
- ✅ **OpenAI** - 完整支持
- ❓ **钱多多 API** - 需验证（使用 OpenAI 兼容接口，可能支持）
- ❌ **DeepSeek** - 暂不支持，请使用同步模式

**Q: 如何获取阿里云百炼 API Key？**
A: 
1. 访问：https://bailian.console.aliyun.com/
2. 开通"百炼"服务
3. 创建 API Key

**Q: 输出文件在哪里？**
A: 
- 结构化提取：默认在 `outputs/<输入文件名>_<时间戳>/` 目录下
- 患者友好化：默认在 `patient_friendly_outputs/<输入文件名>_<时间戳>/` 目录下
- 微调数据集：默认在当前目录，文件名为 `<输入文件名>.jsonl`

**Q: 为什么每次运行都创建新目录？**
A: 为了避免覆盖历史结果，每次运行会自动创建带时间戳的新目录。

**Q: 为什么只处理了部分数据？**
A: 检查是否使用了 `--limit` 参数。去掉该参数即可处理全部数据。

### 模板相关

**Q: `--text-col` 和 `--id-col` 必须和 CSV 列名对应吗？**
A: **是的！** 这两个参数指定的是 CSV 文件中的实际列名。
- 如果 CSV 中文本列叫 "检查所见"，就用 `--text-col "检查所见"`
- 如果 CSV 中文本列叫 "报告内容"，就用 `--text-col "报告内容"`
- 如果不指定，工具会尝试自动检测常见列名

**Q: 使用 `--template lung_cancer` 时，发送给 AI 的 prompt 是什么？**
A: **是肺癌模板的 prompt，不是 rcc 的！** 每个模板有独立的提示词：
- `--template rcc` → 使用肾癌模板的 prompt（关于 PET/CT、肾脏状态等）
- `--template lung_cancer` → 使用肺癌模板的 prompt（关于 CT、肿瘤位置等）
- `--template generic` → 使用通用模板的 prompt

**验证方法：** 查看输出 CSV 的列名。rcc 模板输出 `modality, exam_overview...`，lung_cancer 模板输出 `exam_type, tumor_location...`

**Q: 如何创建自定义模板？**
A: 编辑 `rcc_extract/templates.py`，添加新模板并注册到 `TEMPLATES` 字典中。无需修改其他代码。详细指南请查看 [`自定义模板创建指南.md`](./自定义模板创建指南.md)

**Q: silicon_client.py 是什么文件？**
A: 这是一个**通用的 API 客户端封装文件**，负责与各种 API 供应商通信。虽然名字包含 "silicon"，但它支持所有 OpenAI 兼容的 API（SiliconFlow、阿里云百炼、OpenAI、DeepSeek 等）。

### 性能相关

**Q: 如何提高处理速度？**
A: 
- **同步模式**：增加并发数 `--concurrency 20`，提高 RPM `--rpm 60`（需确保 API 允许）
- **批量模式**：批量模式会自动管理队列，无需手动调整

**Q: 为什么处理速度很慢？**
A: 
- 检查 `--rpm` 和 `--concurrency` 设置是否过低
- 确认 API 配额是否足够
- 考虑使用批量模式（适合 50+ 条数据）

**Q: 遇到 429 错误怎么办？**
A: 系统会自动检测并重试。如果频繁出现，建议：
- 降低 `--rpm` 和 `--concurrency`
- 使用批量模式（自动管理配额）
- 更换配额更宽松的 API 供应商

### 患者友好化相关

**Q: 转换后的文本有多长？**
A: 默认情况下，AI 会根据内容调整长度。如果需要限制长度，可以在自定义提示词中说明。

**Q: 如何调整转换的语气？**
A: 使用 `--system-prompt` 或 `--system-prompt-file` 自定义提示词，可以控制语气（温和/专业/简洁等）。

**Q: 错误处理？**
A: 如果某条记录处理失败，会在 `error` 列显示错误信息，`simplified_text` 为空。

### 微调数据集相关

**Q: 为什么需要 assistant CSV？**
A: 包含 assistant 响应的数据用于**有监督微调**，效果通常比零样本学习更好。如果你有高质量的提取结果，建议使用。

**Q: 可以用其他工具生成的 JSON 作为 assistant 吗？**
A: 可以！只需要将 JSON 格式化为字符串。或者修改脚本支持直接从 JSON 文件读取。

**Q: 数据量多大才够？**
A: 建议至少 50-100 条，500-1000 条或更多效果更好。但数据质量比数量更重要。

---

## 快速参考

### 最常用的命令

#### 结构化提取（阿里云批量处理）

```powershell
$env:ALIYUN_API_KEY = "sk-your-key"
python -m rcc_extract.cli `
  --mode batch `
  --provider aliyun `
  --model "qwen-plus" `
  --input "data.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

#### 结构化提取（测试小批量）

```powershell
python -m rcc_extract.cli `
  --provider aliyun `
  --model "qwen-plus" `
  --input "data.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --limit 5
```

#### 患者友好化

```powershell
python patient_friendly_cli.py `
  --provider aliyun `
  --model "qwen-plus" `
  --input "data.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号"
```

#### 微调数据集转换

```powershell
python convert_to_finetune.py `
  --input "数据.csv" `
  --system "你是一名医学影像分析助手" `
  --user-col "检查所见" `
  --assistant-col "提取结果" `
  --output "finetune.jsonl"
```

### 完整工作流程示例

#### 场景：处理肾癌报告并生成患者友好化文本

**步骤1：结构化提取**
```powershell
$env:ALIYUN_API_KEY = "sk-your-key"

python -m rcc_extract.cli `
  --mode batch `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --template rcc
```

**步骤2：患者友好化**
```powershell
python patient_friendly_cli.py `
  --provider aliyun `
  --model "qwen-plus" `
  --input "工作簿2.csv" `
  --text-col "检查所见" `
  --id-col "门诊号/住院号" `
  --temperature 0.4
```

**步骤3：生成微调数据集（可选）**
```powershell
# 手动合并两个 CSV（原始数据 + 提取结果），然后：
python convert_to_finetune.py `
  --input "合并数据.csv" `
  --system "你是一名核医学影像科医生助手，任务是从 PET/CT 或骨显像报告的"检查所见"描述中提取肾癌相关结构化特征。" `
  --user-col "检查所见" `
  --assistant-col "提取结果" `
  --output "rcc_finetune.jsonl"
```

---

## 📚 相关文档

- **结构化提取详细指南**：查看 `使用指南.md`
- **患者友好化详细指南**：查看 `患者友好化使用指南.md`
- **微调数据集转换详细指南**：查看 `微调数据集转换_快速开始.md`
- **自定义模板创建指南**：查看 `自定义模板创建指南.md`
- **模板使用详解**：查看 `模板使用详解.md`
- **钱多多 API 使用说明**：查看 `钱多多API使用说明.md`

---

## 🎉 开始使用

1. **选择一个工具**（结构化提取 / 患者友好化 / 微调数据集转换）
2. **设置 API Key**（推荐使用阿里云百炼）
3. **准备 CSV 文件**
4. **运行命令**
5. **查看结果**

**祝你使用愉快！如有问题，请查看本文档的常见问题部分。** 🚀

